<!DOCTYPE html>  
<html lang="en">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>Apple Music Cover Downloader</title>  
    <style>  
        body {  
            font-family: 'Inter', sans-serif;  
            max-width: 1200px;  
            margin: 0 auto;  
            padding: 20px;  
            background-color: #fff;  
            color: #333;  
            overflow-y: auto;  
        }  
        h1 {  
            text-align: center;  
            color: #1d1d1f;  
        }  
        #search-container {  
            margin-bottom: 20px;  
        }  
        #search-input {  
            width: 100%;  
            height: 48px;  
            padding: 0 10px;  
            font-size: 16px;  
            border: 2px solid #ddd;  
            border-radius: 2px;  
            box-sizing: border-box;  
        }  
        #search-input:focus {  
            outline: none;  
            border-color: #18a0fb;  
            box-shadow: 0 0 0 3px rgba(24, 160, 251, 0.2);  
        }  
        #results {  
            display: grid;  
            grid-template-columns: repeat(4, 1fr);  
            gap: 15px;  
            width: 100%;  
        }  
        .cover {  
            cursor: pointer;  
            transition: transform 0.3s;  
            position: relative;  
            overflow: hidden;  
            aspect-ratio: 1 / 1;  
            border-radius: 4px;  
        }  
        .cover:hover {  
            transform: scale(1.05);  
        }  
        .cover img {  
            width: 100%;  
            height: 100%;  
            display: block;  
            object-fit: cover;  
        }  
        .cover-info {  
            padding: 10px;  
            text-align: left;  
            background-color: rgba(0, 0, 0, 0.7);  
            position: absolute;  
            bottom: 0;  
            left: 0;  
            right: 0;  
            transition: opacity 0.3s;  
            opacity: 0;  
            color: white;  
        }  
        .cover:hover .cover-info {  
            opacity: 1;  
        }  
        .album-name, .artist-name, .country {  
            white-space: nowrap;  
            overflow: hidden;  
            text-overflow: ellipsis;  
        }  
        .album-name {  
            font-weight: bold;  
            font-size: 0.9em;  
            margin-bottom: 2px;  
        }  
        .artist-name {  
            font-size: 0.8em;  
            color: #ccc;  
        }  
        .country {  
            font-size: 0.7em;  
            color: #999;  
            margin-top: 2px;  
        }  
        #loading {  
            display: none;  
            text-align: center;  
            margin-top: 20px;  
        }  
        .spinner {  
            border: 4px solid #f3f3f3;  
            border-top: 4px solid #18a0fb;  
            border-radius: 50%;  
            width: 40px;  
            height: 40px;  
            animation: spin 1s linear infinite;  
            margin: 0 auto;  
        }  
        @keyframes spin {  
            0% { transform: rotate(0deg); }  
            100% { transform: rotate(360deg); }  
        }  
    </style>  
</head>  
<body>  
    <h1>Apple Music Cover Downloader</h1>  
    <div id="search-container">  
        <input type="text" id="search-input" placeholder="Enter album or artist name">  
    </div>  
    <div id="loading">  
        <div class="spinner"></div>  
    </div>  
    <div id="results"></div>  

    <script>  
        document.addEventListener('DOMContentLoaded', () => {  
            console.log('DOM fully loaded and parsed');  
            const searchInput = document.getElementById('search-input');  
            const resultsContainer = document.getElementById('results');  
            const loadingElement = document.getElementById('loading');  
            let cache = {};  

            const COUNTRIES = ['us', 'cn', 'jp', 'kr', 'gb', 'fr', 'de'];  
            const LIMIT = 360;  
            const corsProxy = 'https://cors-anywhere.herokuapp.com/';  

            searchInput.addEventListener('keypress', (e) => {  
                if (e.key === 'Enter') {  
                    console.log('Enter key pressed, starting search');  
                    search();  
                }  
            });  

            async function search() {  
                const query = preprocessQuery(searchInput.value.trim());  
                if (query.length < 2) {  
                    resultsContainer.innerHTML = '';  
                    return;  
                }  

                if (cache[query]) {  
                    renderResults(cache[query]);  
                    return;  
                }  

                loadingElement.style.display = 'block';  

                try {  
                    console.log('Starting search for query:', query);  
                    const results = await performSearch('search', query);  
                    console.log('Search results:', results);  
                    cache[query] = results;  
                    renderResults(results);  
                } catch (error) {  
                    console.error('Error during search:', error);  
                    resultsContainer.innerHTML = `<p>Error: ${error.message}</p>`;  
                } finally {  
                    loadingElement.style.display = 'none';  
                }  
            }  

            function preprocessQuery(query) {  
                return query.replace(/[^\w\s\u4e00-\u9fa5]/gi, '');  
            }  

            async function performSearch(searchType, term) {  
                console.log('Starting search for:', term);  
                const encodedTerm = encodeURIComponent(term);  
                console.log('Encoded term:', encodedTerm);  
                
                const results = [];  
                for (const country of COUNTRIES) {  
                    const url = `${corsProxy}https://itunes.apple.com/search?term=${encodedTerm}&entity=album&limit=${LIMIT}&country=${country}`;  
                    console.log('Fetching from URL:', url);  
                    try {  
                        const response = await fetch(url, {  
                            headers: {  
                                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'  
                            }  
                        });  
                        console.log('Response status for', country, ':', response.status);  
                        if (!response.ok) {  
                            throw new Error(`HTTP error! status: ${response.status}`);  
                        }  
                        const data = await response.json();  
                        console.log('Data received for', country, ':', data);  
                        results.push(data);  
                    } catch (error) {  
                        console.error(`Error fetching data for ${country}:`, error);  
                    }  
                    // 添加延迟，避免请求过于频繁  
                    await new Promise(resolve => setTimeout(resolve, 1000));  
                }  

                console.log('All data fetched. Processing results...');  
                
                const albums = results.flatMap((data, index) => {  
                    if (!data.results || data.results.length === 0) {  
                        return [];  
                    }  
                    return data.results.map(album => ({  
                        imageUrl: album.artworkUrl100.replace('100x100', '600x600'),  
                        albumName: album.collectionName,  
                        artistName: album.artistName,  
                        country: COUNTRIES[index]  
                    }));  
                });  

                if (albums.length === 0) {  
                    throw new Error('No albums found for any country');  
                }  

                console.log('Processed albums:', albums);  
                return albums.sort(() => Math.random() - 0.5).slice(0, LIMIT);  
            }  

            function renderResults(results) {  
                console.log('Rendering results:', results);  
                resultsContainer.innerHTML = '';  
                if (results.length === 0) {  
                    resultsContainer.innerHTML = '<p>No results found.</p>';  
                    return;  
                }  
                const fragment = document.createDocumentFragment();  

                results.forEach(item => {  
                    const div = document.createElement('div');  
                    div.className = 'cover';  
                    
                    div.innerHTML = `  
                        <img src="${item.imageUrl}" alt="${item.albumName}">  
                        <div class="cover-info">  
                            <div class="album-name">${item.albumName}</div>  
                            <div class="artist-name">${item.artistName}</div>  
                            <div class="country">${item.country.toUpperCase()}</div>  
                        </div>  
                    `;  
                    
                    div.addEventListener('click', () => downloadCover(item.imageUrl, item.albumName));  
                    fragment.appendChild(div);  
                });  

                resultsContainer.appendChild(fragment);  
                console.log('Results rendered');  
            }  

            async function downloadCover(url, name) {  
                try {  
                    const response = await fetch(url);  
                    const blob = await response.blob();  
                    const link = document.createElement('a');  
                    link.href = URL.createObjectURL(blob);  
                    link.download = `${name.replace(/[^a-z0-9\u4e00-\u9fa5]/gi, '_').toLowerCase()}_cover.jpg`;  
                    document.body.appendChild(link);  
                    link.click();  
                    document.body.removeChild(link);  
                } catch (error) {  
                    console.error('Download error:', error);  
                }  
            }  
        });  
    </script>  
</body>  
</html>